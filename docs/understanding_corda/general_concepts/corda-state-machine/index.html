<!doctype html>
<html lang="jp" class="no-js">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="generator" content="Hugo 0.87.0" /><META NAME="ROBOTS" CONTENT="NOINDEX, NOFOLLOW">


<link rel="shortcut icon" href="/favicons/favicon.ico" >
<link rel="apple-touch-icon" href="/favicons/apple-touch-icon-180x180.png" sizes="180x180">
<link rel="icon" type="image/png" href="/favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="/favicons/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/favicons/android-36x36.png" sizes="36x36">
<link rel="icon" type="image/png" href="/favicons/android-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="/favicons/android-72x72.png" sizes="72x72">
<link rel="icon" type="image/png" href="/favicons/android-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="/favicons/android-144x144.png" sizes="144x144">
<link rel="icon" type="image/png" href="/favicons/android-192x192.png" sizes="192x192">

<title>Corda State Machine 概要 | Welcome to Corda Guide記事</title><meta property="og:title" content="Corda State Machine 概要" />
<meta property="og:description" content="Summary of Corda state machine
" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/docs/understanding_corda/general_concepts/corda-state-machine/" /><meta property="article:section" content="docs" />
<meta property="article:published_time" content="2021-08-21T19:37:43+09:00" />
<meta property="article:modified_time" content="2021-08-21T19:37:43+09:00" /><meta property="og:site_name" content="Welcome to Corda Guide記事" />

<meta itemprop="name" content="Corda State Machine 概要">
<meta itemprop="description" content="Summary of Corda state machine
"><meta itemprop="datePublished" content="2021-08-21T19:37:43+09:00" />
<meta itemprop="dateModified" content="2021-08-21T19:37:43+09:00" />
<meta itemprop="wordCount" content="111">
<meta itemprop="keywords" content="state machine,cordapp," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Corda State Machine 概要"/>
<meta name="twitter:description" content="Summary of Corda state machine
"/>





<link rel="preload" href="/scss/main.min.ca45b9fd0a705194373ce142b0d981532e14e6ef0f337d4bf9ea1b1d810ca9a6.css" as="style">
<link href="/scss/main.min.ca45b9fd0a705194373ce142b0d981532e14e6ef0f337d4bf9ea1b1d810ca9a6.css" rel="stylesheet" integrity="">


<script
  src="https://code.jquery.com/jquery-3.5.1.min.js"
  integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
  crossorigin="anonymous"></script>

<script
  src="https://unpkg.com/lunr@2.3.8/lunr.min.js"
  integrity="sha384-vRQ9bDyE0Wnu+lMfm57BlYLO0/XauFuKpVsZPs7KEDwYKktWi5+Kz3MP8++DFlRY"
  crossorigin="anonymous"></script>




  </head>
  <body class="td-page">
    <header>
      
<nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar">
        <a class="navbar-brand" href="/">
		<span class="navbar-logo"><svg version="1.0" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 344 147"><g transform="translate(0.000000,147.000000) scale(0.100000,-0.100000)" fill="#000" stroke="none"><path d="M282 1444c-98-26-152-66-188-140-22-45-26-64-22-118 7-116 76-184 238-232 244-74 270-89 270-154 0-127-228-134-423-14-32 20-60 34-61 33-2-2-22-35-45-74l-41-70 22-19c35-29 156-83 223-101 34-9 102-15 161-15 180 0 295 54 350 165 23 49 26 64 21 122-10 123-82 186-287 249-151 46-165 52-195 80-35 32-35 85 1 113 65 51 215 34 389-45 8-3 85 133 85 150 0 10-129 59-187 71-86 18-242 18-311-1z"/><path d="M880 999V548l263 4c210 3 270 7 304 20 144 56 208 168 170 299-17 56-53 1e2-115 137l-32 19 39 26c94 62 108 219 28 305-32 35-104 69-172 81-32 6-155 11-272 11H880V999zm470 269c63-43 61-119-4-159-26-16-51-19-153-19h-123v1e2 1e2h124c111 0 126-2 156-22zm-9-348c113-32 120-164 11-201-21-8-87-13-157-14h-120l-3 113-3 112h118c65 0 134-5 154-10z"/><path d="M1710 1e3V550h1e2 1e2v450 450h-1e2-1e2V1e3z"/><path d="M2112 1148l3-303 83-3 82-3v167c0 151 2 170 21 204 27 48 84 80 155 87 55 6 56 6 109 77l54 71-102 3c-93 2-161-8-219-33-14-5-18-2-18 14 0 20-5 21-85 21h-85l2-302z"/><path d="M2626 1375l-56-75h130c71 0 130-4 130-8 0-5-29-48-65-95l-65-87 41-66c31-49 46-64 58-59 67 27 150 9 198-41 104-111-1-274-161-250-57 9-122 66-132 114l-6 32h-84c-97 0-98-1-64-93 29-76 79-130 158-169 61-30 74-33 162-33 82 0 103 4 151 26 119 56 184 154 183 274-1 84-25 142-86 203-42 43-128 92-160 92-10 0-18 4-18 8 0 5 25 42 55 82 55 73 55 74 55 147v73h-184-184l-56-75z"/><path d="M3290 970c-11-11-20-33-20-50 0-69 96-98 140-43 25 32 21 77-8 99-27 21-89 17-112-6z"/><path d="M1e3 355c0-23 4-25 45-25h45v-85c0-82-1-86-25-97-20-9-32-8-59 5-32 15-35 15-52-4-20-22-20-21 23-43 52-26 109-21 144 13 29 29 29 31 29 145v116h-75c-73 0-75-1-75-25z"/><path d="M1268 321c-44-15-49-20-38-42 9-16 15-17 31-9 11 6 39 10 62 8 35-2 43-7 45-25 3-22 0-23-56-23-73 0-105-21-105-69 0-18 7-39 15-48 21-21 99-29 129-13 17 10 24 10 27 1 2-6 15-11 28-11 24 0 24 1 24 93 0 86-2 95-24 116-27 26-93 36-138 22zm102-145c0-19-39-46-66-46-26 0-48 24-40 45s106 22 106 1z"/><path d="M1507 323c-4-3-7-75-7-160V10h30c30 0 30 1 30 54v55l28-15c68-35 153-3 172 66 28 104-69 192-161 146-39-20-39-20-39-1 0 15-40 21-53 8zm182-69c35-45 22-93-30-113-30-11-83 8-93 34-21 55 11 105 68 105 25 0 40-7 55-26z"/><path d="M1863 316c-35-16-40-27-20-44 8-7 18-7 27-2 21 14 84 12 98-2 27-27 13-38-48-38-51 0-65-4-85-25-14-13-25-33-25-45 0-36 44-70 90-70 23 0 50 5 61 10 13 7 19 7 19 0 0-5 14-10 30-10h30v89c0 79-3 93-23 117-29 33-104 43-154 20zm117-140c0-19-39-46-66-46-26 0-48 24-40 45s106 22 106 1z"/><path d="M2110 210V90h30 30v74c0 69 2 76 26 95 33 26 58 27 84 1 16-16 20-33 20-95 0-73 1-75 25-75 25 0 25 1 25 89 0 105-3 117-41 136-36 19-66 19-103 0-35-18-36-18-36 0 0 10-10 15-30 15h-30V210z"/></g></svg></span>
		
	</a>
	<div class="td-navbar-nav-scroll ml-md-auto" id="main_navbar">
		<ul class="navbar-nav mt-2 mt-lg-0">
			
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				<a  class="nav-link active" href="/docs/" ><span class="active">ドキュメンテーション</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				<a  class="nav-link active" href="/community/" ><span class="active">コミュニティ</span></a>
			</li>
			
			
			
		</ul>
	</div>
	<div class="navbar-nav d-none d-lg-block">



<input
  type="search"
  class="form-control td-search-input"
  placeholder="Search on this site..."
  aria-label=""
  autocomplete="off"
  
  data-offline-search-index-json-src="/offline-search-index.6fca127efea2396a2a5eee9751c65ce2.json"
  data-offline-search-base-href="/"
  data-offline-search-max-results="10"
>
</div>
</nav>

    </header>
    <div class="container-fluid td-outer">
      <div class="td-main">
        <div class="row flex-xl-nowrap">
          <div class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none">
            





<div id="td-sidebar-menu" class="td-sidebar__inner">
  
  
  
  <nav class="collapse td-sidebar-nav" id="td-section-nav">
    
    
    
    
    
    <ul class="td-sidebar-nav__section pr-md-3 pt-lg-5 ul-0">
      
















<li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id="m-docs-li">
  <a href="/docs/" title="" class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__section tree-root" id="m-docs"><span class="">ドキュメンテーション</span></a>
  
  
  <ul class="pr-md-3 ul-1">
    
    
    
















<li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id="m-docsdevelopers-li">
  <a href="/docs/developers/" class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__section" id="m-docsdevelopers"><span class="">Cordaの開発</span></a>
  
  
  <ul class="pr-md-3 ul-2">
    
    
    
















<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id="m-docsdevelopersnetwork_operations-li">
  <a href="/docs/developers/network_operations/" class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__section" id="m-docsdevelopersnetwork_operations"><span class="">Network Operations</span></a>
  
</li>

    
    
    
    
















<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id="m-docsdevelopersnode_operations-li">
  <a href="/docs/developers/node_operations/" class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__section" id="m-docsdevelopersnode_operations"><span class="">Node operations</span></a>
  
</li>

    
    
    
    
















<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id="m-docsdevelopersperformance-li">
  <a href="/docs/developers/performance/" class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__section" id="m-docsdevelopersperformance"><span class="">Performance</span></a>
  
</li>

    
    
    
    
















<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id="m-docsdeveloperssamples-li">
  <a href="/docs/developers/samples/" class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__section" id="m-docsdeveloperssamples"><span class="">Samples</span></a>
  
</li>

    
    
    
    
















<li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child collapse" id="m-docsdeveloperscordapp_development-li">
  <a href="/docs/developers/cordapp_development/" class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__section" id="m-docsdeveloperscordapp_development"><span class="">CorDapp開発</span></a>
  
  
  <ul class="pr-md-3 ul-3">
    
    
    
















<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id="m-docsdeveloperscordapp_developmentdocker-bootstrap-li">
  <a href="/docs/developers/cordapp_development/docker-bootstrap/" class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__page" id="m-docsdeveloperscordapp_developmentdocker-bootstrap"><span class="">DockerComposeを使用したネットワークブートストラップする</span></a>
  
</li>

    
    
    
    
















<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id="m-docsdeveloperscordapp_developmentsignature-constraint-li">
  <a href="/docs/developers/cordapp_development/signature-constraint/" class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__page" id="m-docsdeveloperscordapp_developmentsignature-constraint"><span class="">Signature Constraint</span></a>
  
</li>

    
    
  </ul>
  
</li>

    
    
    
    
















<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id="m-docsdevelopersdesign-li">
  <a href="/docs/developers/design/" class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__section" id="m-docsdevelopersdesign"><span class="">Architecture Design</span></a>
  
</li>

    
    
    
    
















<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id="m-docsdevelopersgetting_started-li">
  <a href="/docs/developers/getting_started/" class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__section" id="m-docsdevelopersgetting_started"><span class="">Getting Started</span></a>
  
</li>

    
    
  </ul>
  
</li>

    
    
    
    
















<li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id="m-docsfaq-li">
  <a href="/docs/faq/" class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__section" id="m-docsfaq"><span class="">FAQ</span></a>
  
  
  <ul class="pr-md-3 ul-2">
    
    
    
















<li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child collapse" id="m-docsfaqtechnology-li">
  <a href="/docs/faq/technology/" class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__section" id="m-docsfaqtechnology"><span class="">Technology</span></a>
  
  
  <ul class="pr-md-3 ul-3">
    
    
    
















<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id="m-docsfaqtechnologyprivacy-li">
  <a href="/docs/faq/technology/privacy/" class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__page" id="m-docsfaqtechnologyprivacy"><span class="">データのプライバシー確保</span></a>
  
</li>

    
    
  </ul>
  
</li>

    
    
    
    
















<li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child collapse" id="m-docsfaqbusiness-li">
  <a href="/docs/faq/business/" class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__section" id="m-docsfaqbusiness"><span class="">Business</span></a>
  
  
  <ul class="pr-md-3 ul-3">
    
    
    
















<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id="m-docsfaqbusinesscorda-open-source-li">
  <a href="/docs/faq/business/corda-open-source/" class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__page" id="m-docsfaqbusinesscorda-open-source"><span class="">Corda Open Sourceの商用環境への利用</span></a>
  
</li>

    
    
  </ul>
  
</li>

    
    
  </ul>
  
</li>

    
    
    
    
















<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docsrelease_notes-li">
  <a href="/docs/release_notes/" class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__section" id="m-docsrelease_notes"><span class="">Release Notes</span></a>
  
</li>

    
    
    
    
















<li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id="m-docsunderstanding_corda-li">
  <a href="/docs/understanding_corda/" class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__section" id="m-docsunderstanding_corda"><span class="">Cordaの理解</span></a>
  
  
  <ul class="pr-md-3 ul-2">
    
    
    
















<li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id="m-docsunderstanding_cordageneral_concepts-li">
  <a href="/docs/understanding_corda/general_concepts/" class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__section" id="m-docsunderstanding_cordageneral_concepts"><span class="">Corda General Concepts</span></a>
  
  
  <ul class="pr-md-3 ul-3">
    
    
    
















<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child active-path" id="m-docsunderstanding_cordageneral_conceptscorda-state-machine-li">
  <a href="/docs/understanding_corda/general_concepts/corda-state-machine/" class="align-left pl-0 pr-2 active td-sidebar-link td-sidebar-link__page" id="m-docsunderstanding_cordageneral_conceptscorda-state-machine"><span class="td-sidebar-nav-active-item">Corda State Machine 概要</span></a>
  
</li>

    
    
    
    
















<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docsunderstanding_cordageneral_conceptscorda46-introduction-li">
  <a href="/docs/understanding_corda/general_concepts/corda4.6-introduction/" class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__page" id="m-docsunderstanding_cordageneral_conceptscorda46-introduction"><span class="">Corda 4.6 Introduction</span></a>
  
</li>

    
    
  </ul>
  
</li>

    
    
  </ul>
  
</li>

    
    
  </ul>
  
</li>

    </ul>
  </nav>
</div>



          </div>
          <div class="d-none d-xl-block col-xl-2 td-toc d-print-none">
            











<nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#注意事項">注意事項</a></li>
      </ul>
    </li>
  </ul>

  <ul>
    <li><a href="#1-flowの開始">1. Flowの開始</a></li>
    <li><a href="#2-実行と一時停止">2. 実行と一時停止</a></li>
    <li><a href="#3-メッセージ受信と再開">3. メッセージ受信と再開</a></li>
    <li><a href="#4-実行完了">4. 実行完了</a></li>
  </ul>
</nav>



            

	
		
			
		
		



  
  

	
		
			
		
		



  
  
    <div class="taxonomy taxonomy-terms-cloud taxo-tags">
      
        <h5 class="taxonomy-title">Tag Cloud</h5>
      
      <ul class="taxonomy-terms">
        
          <li><a class="taxonomy-term" style="font-weight: 300; padding-bottom: .25rem; display: inline-block" href="/tags/bootstrap/" data-taxonomy-term="bootstrap"><span class="taxonomy-label">bootstrap</span><span class="taxonomy-count">1</span></a></li>
        
          <li><a class="taxonomy-term" style="font-weight: 300; padding-bottom: .25rem; display: inline-block" href="/tags/cordapp/" data-taxonomy-term="cordapp"><span class="taxonomy-label">cordapp</span><span class="taxonomy-count">1</span></a></li>
        
          <li><a class="taxonomy-term" style="font-weight: 300; padding-bottom: .25rem; display: inline-block" href="/tags/docker/" data-taxonomy-term="docker"><span class="taxonomy-label">docker</span><span class="taxonomy-count">1</span></a></li>
        
          <li><a class="taxonomy-term" style="font-weight: 300; padding-bottom: .25rem; display: inline-block" href="/tags/open-source/" data-taxonomy-term="open-source"><span class="taxonomy-label">open source</span><span class="taxonomy-count">1</span></a></li>
        
          <li><a class="taxonomy-term" style="font-weight: 300; padding-bottom: .25rem; display: inline-block" href="/tags/privacy/" data-taxonomy-term="privacy"><span class="taxonomy-label">privacy</span><span class="taxonomy-count">1</span></a></li>
        
          <li><a class="taxonomy-term" style="font-weight: 300; padding-bottom: .25rem; display: inline-block" href="/tags/security/" data-taxonomy-term="security"><span class="taxonomy-label">security</span><span class="taxonomy-count">1</span></a></li>
        
          <li><a class="taxonomy-term" style="font-weight: 300; padding-bottom: .25rem; display: inline-block" href="/tags/state-machine/" data-taxonomy-term="state-machine"><span class="taxonomy-label">state machine</span><span class="taxonomy-count">1</span></a></li>
        
      </ul>
    </div>
  

	

          </div>
          <main class="col-12 col-md-9 col-xl-8 pl-md-5" role="main">
            
  

            <nav aria-label="breadcrumb" class="d-none d-md-block d-print-none">
	<ol class="breadcrumb spb-1">
		













<li class="breadcrumb-item" >
	<a href="/docs/">ドキュメンテーション</a>
</li>




<li class="breadcrumb-item" >
	<a href="/docs/understanding_corda/">Cordaの理解</a>
</li>




<li class="breadcrumb-item" >
	<a href="/docs/understanding_corda/general_concepts/">Corda General Concepts</a>
</li>




<li class="breadcrumb-item active" aria-current="page">
	<a href="/docs/understanding_corda/general_concepts/corda-state-machine/">Corda State Machine 概要</a>
</li>

	</ol>
</nav	>

            <nav>
              
              <div>Tags: <a class="taxonomy-term" href="/tags/state%20machine/">#state machine</a> <a class="taxonomy-term" href="/tags/cordapp/">#cordapp</a></div>
          </nav>
            
<div class="td-content">
	<h1>Corda State Machine 概要</h1>
    <div class="lead">Summary of Corda state machine</div>
	       
	<p>

<div class="pageinfo pageinfo-primary">
<p>この記事はR3ブログから翻訳されています。英文オリジナルの記事は<a href="https://www.corda.net/blog/overview-of-the-corda-state-machine/">こちら</a>。</p>

</div>

CordaのFlowは、KotlinまたはJavaを用いて、分岐のない一連のないプログラムとして記述できます。しかし、実行時には多くの分岐や補完的な動作が発生します。例えば・・</p>
<ul>
<li>Checkpointでの状態保存（障害耐性確保の為）</li>
<li>SubFlowの実行</li>
<li>他のノードへのメッセージ送信とその後の受信待機</li>
<li>非同期呼び出しと、その結果待ち</li>
</ul>
<p>等です。</p>
<p>Cordaは、Quasar fiber をベースにしたState Machine上で動作することで、こうした分岐／補完動作を実現しています。</p>
<p>この記事は、こうした動作の概要を説明することが目的です。動作を理解することで、Cordaノードの運用を行うにあたっての基礎になると考えます。</p>
<h3 id="注意事項">注意事項</h3>
<p>概念の説明を中心に行っていて、エラー処理を無視しています。Cordaのステートマシン/フローフレームワーク/ P2Pメッセージングに実際に変更を加える場合は、もう少し詳細を理解する必要があります。技術的詳細については<a href="https://docs.corda.net/contributing-flow-internals.html?highlight=state%20machine#flow-framework-internals">Cordaの英文ドキュメントサイト</a>をご覧ください。
現在の実装に基づいて説明していますが、将来変更される可能性があります。CorDappを作成する場合は、公式のドキュメントとAPIに基づいて設計してください。ドキュメントを理解する助けとなる事がこの記事の目的であって、技術的な代替手段を検討するためのものではありません。</p>
<h1 id="quasarとは">Quasarとは？</h1>
<p><a href="https://docs.paralleluniverse.co/quasar/">Quasar</a>は、Javaバイトコードの巧妙な書き換えと例外を利用して、継続（contiuation、情報処理用語でプログラムの実行に関して、ある時点で中断され、評価されていない残りのプログラムを再度実行する機能を指す）を提供するJavaライブラリです。</p>
<p>Quasarにおけるもっとも重要な概念はfiberです。fiberとは、プログラムコードにおけるスレッドのようなものですが、fiberは自らを一時停止できます。その時点で、その計算状態を保存することができます。保存された状態を元に戻し、そこから再び計算を始めることができます。</p>
<p>さて、この機能を実現する仕組みをまずは学びましょう。</p>
<p>ユーザーは，中断可能であるすべての関数に対して<code>@Suspendable</code>というアノテーションをつける必要があります。起動時とJITコンパイルの直前に、Quasarは，<code>@Suspendable</code>メソッドのバイトコードを書き換えます。具体的には、<code>throws SuspendExecution</code>を関数定義に追加し,全ての<code>catch</code>ブロックに、<code>SuspendExecution</code>を再スローするコードを追加します。この例外をユーザーコードでキャッチさせないためです。</p>
<p><img src="/docs/images/understanding_corda/corda-state-machine-1.png" alt="image"></p>
<p>fiberを中断するために、プログラムはQuasarの特定の関数（例えば?<code>parkAndSerialize</code>）を呼び出します。この関数は<code>SuspendExecution</code>を投げ、投げられたこの例外はすべてのユーザーコードを通過し、Quasarによってキャッチされます。Quasarは、コールスタックを抽出し、シリアライズして保存します。バイトコードインストゥルメンテーション（byte code instrumentation）は、コールスタック上の関数が使用する変数、ローカルオブジェクト、スレッドが使用しているローカルストレージ等の値を全て確保でき、fiberはこのひと固まりのスレッドを再構成することができます。また、これらすべてをメモリに保存した後、CPUは現在の実行スレッドを解放するので、CPUは他の何かを実行するためにこの実行スレッドを利用可能になります。</p>
<p>ファイバーを復元すると、コールスタックが新しいスレッドで再作成され、すべての値が記録されたとおりに関数に渡され、スレッドのローカルストレージが復元され、停止したところから実行が続行されます。</p>
<p>これを機能させるには、中断するスタック内のすべての関数に<code>@Suspendable</code>アノテーション付けて、クエーサーがそれらを計測できるようにすることが重要です。そうしないと、例外がキャッチされるか、パラメーターが正しくキャプチャされず、fiberが正しく中断されません。これは、CorDappsのエラーの一般的な原因（transaction context missingエラーなど）であり、スタックのどの関数に注釈が欠けているかを把握するのは非常に難しい場合があります。</p>
<p>CordaのFlowはQuasarをラップし、それを使用して、CorDappのflow logic実装に含まれるKotlinまたはJavaのコードを、一時停止可能なコードに変換します。一時停止可能だと指定した場所をcheckpointと呼び、システムは任意のcheckpointからコードを再実行できる事が保証されます。</p>
<h1 id="flowの状態遷移">Flowの状態遷移</h1>
<p>さて、FlowがCheckPointで中止＆再開できる仕組みを見てきたところで、次にFlowの状態遷移についてみていきましょう。FlowはQuasarによる一時停止機能がある事を前提に、次のような状態遷移を想定しています。</p>
<p>まず、すべてのフローはPending状態から始まります。次にrunningに移行します。最も簡単なケースでは、最終的にコードの最後に到達してsuccessに移行し、結果が返されます。コード途中で指定され、保存されていたCheckPointは全て消去されます。</p>
<p><img src="/docs/images/understanding_corda/corda-state-machine-2.png" alt="image"></p>
<p>エラーが発生した場合はErroedに移行し、<code>FlowHospital</code>が管理することになります。<code>FlowHospital</code>では3つの可能性があります。</p>
<p>一時的なエラーの場合、Pendingに戻って再実行されます。この時、Flowは最初から実行されるのではなく、記録された最後のチェックポイントから再試行されます。
エラーが致命的である場合、フローは失敗Failedとして終了します。エラーが呼び出し元に返され、すべてのCheckPointが削除されます。
エラーを単純に再試行することはできないが、失敗させることができない場合（たとえば、元帳の整合性が失われる可能性がある場合など）、Flowはheld状態に移行します。hold状態の解消には、次のような人間の介入が必要です。
エラーの原因となった状態を修正する。
最後のCheckPointから手動でフローを再開する。（現状、これはNodeの再起動によって実現します。将来のリリースでRPCによる再開が実装される予定です）</p>
<h1 id="flowのライフサイクル">Flowのライフサイクル</h1>
<p>Flowのライフサイクルを考えるとき、Cordaノードを「ユーザースペース」と「カーネルスペース」に分けて考えると便利です。「ユーザースペース」は、ユーザーが提供するFlow logicを実行し、「カーネルスペース」は、ユーザーの提供するコードを実行するFlowフレームワークです。</p>
<p>典型的なフローはあるスレッドで実行が開始され、ネットワーク上の他のノードに送付され、帰ってきたレスポンスを受けて再開するという流れをたどります。この流れの詳細を確認していきましょう。</p>
<p>![image]/docs/images/understanding_corda/corda-state-machine-3.png)</p>
<h2 id="1-flowの開始">1. Flowの開始</h2>
<p>RPCを介してFlowがキックされると、<code>StartFlow</code>がカーネルスペースで呼び出されます。これにより、Flowを開始するイベントがスケジュールされます（RPC処理とメッセージのデシリアライズ処理は別のスレッドプールで行われることに注意してください）CPUの実行スレッドが使用可能になるとすぐに、メッセージの処理を開始し、FlowはPendingからRunningに移行します。この作業には以下の作業も含まれます。</p>
<p>スレッドを取得する。
データベース接続を取得して（fiberを保存するための）トランザクションを開く。
CorDappから要求されたFlowLogicをインスタンス化し、必要なパラメータを渡す。
FlowLogicのrun関数を呼び出す。</p>
<h2 id="2-実行と一時停止">2. 実行と一時停止</h2>
<p>次に、ユーザーコードは、一時停止が必要なポイントに到達するまで実行されます。一時停止の最も一般的な条件は次のとおりです。</p>
<p>メッセージを送信した場合
FlowLogic.sleep()の呼び出し。つまり、明示的に一定時間Flowを一時停止する場合
Flow非同期API（<code>FlowLogic.await()</code>）の使用</p>
<p>ここでは、Flowが他の一つのノードと<code>sendAndReceive()</code>を用いて通信する。この関数はカーネル空間を呼び出し、次のことを行います。</p>
<p>ペイロードをシリアル化して、この関数に渡します。
メッセージを送信キューに入れると、P2Pメッセージングシステムによってピックアップされます。（P2PメッセージングシステムArtemisは、それだけで一つの記事が書けるほどのものです。ここでは、このシステムは頑健で、正確に1度だけメッセージを送信することができることだけを述べます。）このシステムによって、メッセージが正しく配信され（いずれ）返信を受け取ることができると想定できます。
次に、Quasarの<code>parkAndSerialize</code>関数を呼び出して、前節で示した通りコールスタック他の情報を記録します。
ノードはこのFlowに割り当てられたリソースの中で、Quasarが無視してしまう部分の後処理をする必要もあります。典型的には、開いているデータベーストランザクションをコミットして、データベース接続を解放する必要があります．他のリソース（ロックなど）も同様に処理する必要があります。これはCordaコードで行われます。
Cordaはまた、Checkpointでのコピーをデータベースに保存するため、中断されたフローも再起動することができます。
Kryoシリアライザーを使用するので、スタック上で見つかったものはすべてシリアル化できます。これは、RPCおよびP2P通信で使用されるシリアライザやStatesをデータベースに保存する際に使われるシリアライザとは異なる仕組みです。通信用やState用はその内容に制約や制限が必要ですが、CheckPoint用シリアライザは、すべてを受け入れる必要があります。一方で、データ形式や構造の変化に対処する必要はありません。
シリアルの際に無視する必要のあるもの（主にノードやState Machineそのものなどで、デシリアライズ処理時にも当然にメモリ上に存在するモノ）のリストがあります。
特定のクラス（Cordaサービスなど）は<code>SerializeAsToken</code>インターフェースを実装していて、クラスインスタンスの代わりにトークン化したデータだけが記録されます。これらのクラスは、デシリアライズ処理の際にインスタンスを取得するメカニズムを別途指定する必要があります。特にシングルトンクラスをシリアライズする時に役立ちます。</p>
<p>その後、fiberはRunningからSuspendedに移行し、CPUの実行スレッドは他のタスクを実行できるようになります。</p>
<h2 id="3-メッセージ受信と再開">3. メッセージ受信と再開</h2>
<p>送信したメッセージに対する応答メッセージが到着すると、P2Pメッセージングシステムは、fiberへ再起動を促すメッセージをイベントキューに置きます。CPUの実行スレッドが使用可能になると、中断されたfiberの状態遷移が次ようにして再開します。</p>
<p>コールスタックと変数が再作成されます
リソースが再取得されます（例えば，DB接続およびトランザクションが開かれます）
受信したメッセージはデシリアライズされます
受信メッセージは、Flowが再びSuspendedするか、終了したときにのみP2Pメッセージングシステム上から削除されます。何らかのエラーに伴うフェイルオーバーが起きた場合、フローはメッセージ送信直後のチェックポイントから再実行され、P2Pメッセージングキューからメッセージを再受信します。
次に、ユーザー空間のFlowLogicが、<code>sendAndReceive</code> を叩いた時点の状態で呼び出され、メッセージの内容を関数呼び出しの戻り値として渡します。</p>
<h2 id="4-実行完了">4. 実行完了</h2>
<p><code>FlowLogic</code>が最後まで正常に完了すると、制御はカーネル空間に戻り、次の処理が行われます。</p>
<p>データベーストランザクションがコミットされます
このフローのすべてのCheckPointがデータベースから削除されます。
P2Pメッセージングシステムに保存されていた未処理のメッセージはキューから削除されます。
関数戻り値はRPCプールに渡されます。シリアル化されて呼び出し元のクライアントに送り返すことになります。
データベース接続が解放され、fiberが終了し、CPUの実行スレッドが解放されます。</p>
<h1 id="含意">含意</h1>
<p>この上記の実装は、CorDappsの開発者にいくつかの影響を与えます</p>
<ul>
<li>
<p>別途、生のJDBC接続を張りに行っても通常のACIDデータベースロジックをCorDappsで単純に使用することはできません。</p>
<ul>
<li>
<p>Flow logic中で、DBを単純にコミットすることはできません（FlowLogic.sleep(1.millis)は妥当で現実的な回避策です）</p>
</li>
<li>
<p>一時停止により、想定外のDBコミットが発生する可能性があります。</p>
</li>
<li>
<p>Flowが失敗した場合、DBトランザクションはロールバックされます。使用しているJDBC接続で別途何かを行った場合、それは失われます。再試行すると、フローは最後のメッセージから再開されるため、DBトランザクションが再発生します。</p>
</li>
<li>
<p>DBトランザクションをロールバックすることはできません。FlowLogic内はFlowベースのトランザクション内にいるためです。SQLコードを直接記述して何か問題が発生し、ロールバックした場合、元帳の整合性が脅かされる可能性があります</p>
</li>
</ul>
</li>
<li>
<p>Flowのすべての部分が少なくとも1回実行されます。ただし、問題が発生した場合、最後のCheckpointからエラーが発生したポイントの間の部分が再実行されます。Flowは、ロールバックを介して発生するすべてのDBトランザクションをクリアしてクリーンに再実行できるようにしますが、サードパーティコンポーネントとの他のやり取りは、べき等であるか、複数回の呼び出しを処理できる必要があります。</p>
</li>
<li>
<p><code>@Suspendable</code>アノテーションは、非常に注意深く使用なければなりません。<code>@Suspendable</code> ではない関数から、<code>@Suspendable</code>な関数を呼ぶことはできません。（逆は問題はありません。<code>@Suspendable</code> な関数からデータベース操作などの<code>@Suspendable</code>ではない関数を呼び出すことは可能です。）
バイトコードのスキャン/再読み込みは、かなり時間がかかります。サスペンド操作は安価ではありません。
バイトコードインストゥルメンテーション（byte code instrumentation）がうまくできないコードを書いてしまう事があります。（例えば、Kotlinの?.map{}操作内で<code>@Suspendable</code>関数を使用する等）この場合、再生成されるバイトコードが無効化され、JVMが実行時にあきらめる可能性があります。これは<a href="(https://youtrack.jetbrains.com/issue/KT-19251)">Kotlinの既知の問題</a>であり、この問題が発生した場合、以下のようなコンパイルオプションを指定することで改善できます。
<br><br><br></p>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-groovy" data-lang="groovy"><span style="color:#000">compileKotlin</span> <span style="color:#ce5c00;font-weight:bold">{</span>
     <span style="color:#000">kotlinOptions</span> <span style="color:#ce5c00;font-weight:bold">{</span> 
          <span style="color:#000">freeCompilerArgs</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">[</span><span style="color:#4e9a06">&#34;-Xnormalize-constructor-calls=enable&#34;</span><span style="color:#ce5c00;font-weight:bold">]</span>
     <span style="color:#ce5c00;font-weight:bold">}</span>
<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div>
	
		<style>
  .feedback--answer {
    display: inline-block;
  }
  .feedback--answer-no {
    margin-left: 1em;
  }
  .feedback--response {
    display: none;
    margin-top: 1em;
  }
  .feedback--response__visible {
    display: block;
  }
</style>
<div class="d-print-none">
<h2 class="feedback--title">Feedback</h2>
<p class="feedback--question">Was this page helpful?</p>
<button class="feedback--answer feedback--answer-yes">Yes</button>
<button class="feedback--answer feedback--answer-no">No</button>
<p class="feedback--response feedback--response-yes">
  Glad to hear it! Please <a href="https://github.com/sbir3japan/sbir3japan.github.io/issues/new">tell us how we can improve</a>.
</p>
<p class="feedback--response feedback--response-no">
  Sorry to hear that. Please <a href="https://github.com/sbir3japan/sbir3japan.github.io/issues/new">tell us how we can improve</a>.
</p>
</div>
<script>
  const yesButton = document.querySelector('.feedback--answer-yes');
  const noButton = document.querySelector('.feedback--answer-no');
  const yesResponse = document.querySelector('.feedback--response-yes');
  const noResponse = document.querySelector('.feedback--response-no');
  const disableButtons = () => {
    yesButton.disabled = true;
    noButton.disabled = true;
  };
  const sendFeedback = (value) => {
    if (typeof ga !== 'function') return;
    const args = {
      command: 'send',
      hitType: 'event',
      category: 'Helpful',
      action: 'click',
      label: window.location.pathname,
      value: value
    };
    ga(args.command, args.hitType, args.category, args.action, args.label, args.value);
  };
  yesButton.addEventListener('click', () => {
    yesResponse.classList.add('feedback--response__visible');
    disableButtons();
    sendFeedback(1);
  });
  noButton.addEventListener('click', () => {
    noResponse.classList.add('feedback--response__visible');
    disableButtons();
    sendFeedback(0);
  });
</script>

		<br />
	
	
	<div class="text-muted mt-5 pt-3 border-top"> August 21, 2021
</div>
</div>


          </main>
        </div>
      </div>
      
<footer class="bg-dark py-5 row d-print-none">
  <div class="container-fluid mx-sm-5">
    <div class="row">
      <div class="col-6 col-sm-4 text-xs-center order-sm-2">
        
        
        
<ul class="list-inline mb-0">
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="SBI-R3 Japan Twitter" aria-label="SBI-R3 Japan Twitter">
    <a class="text-white" target="_blank" rel="noopener noreferrer" href="https://twitter.com/R3Sbi">
      <i class="fab fa-twitter"></i>
    </a>
  </li>
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Corda Twitter" aria-label="Corda Twitter">
    <a class="text-white" target="_blank" rel="noopener noreferrer" href="https://twitter.com/corda">
      <i class="fab fa-twitter"></i>
    </a>
  </li>
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Medium" aria-label="Medium">
    <a class="text-white" target="_blank" rel="noopener noreferrer" href="https://medium.com/corda-japan">
      <i class="fab fa-medium"></i>
    </a>
  </li>
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Facebook" aria-label="Facebook">
    <a class="text-white" target="_blank" rel="noopener noreferrer" href="https://www.facebook.com/R3DLTJapan/">
      <i class="fab fa-facebook"></i>
    </a>
  </li>
  
</ul>

        
        
      </div>
      <div class="col-6 col-sm-4 text-right text-xs-center order-sm-3">
        
        
        
<ul class="list-inline mb-0">
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="GitHub" aria-label="GitHub">
    <a class="text-white" target="_blank" rel="noopener noreferrer" href="https://github.com/corda">
      <i class="fab fa-github"></i>
    </a>
  </li>
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Slack" aria-label="Slack">
    <a class="text-white" target="_blank" rel="noopener noreferrer" href="https://slack.corda.net/">
      <i class="fab fa-slack"></i>
    </a>
  </li>
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Stack Overflow" aria-label="Stack Overflow">
    <a class="text-white" target="_blank" rel="noopener noreferrer" href="https://stackoverflow.com/questions/tagged/corda">
      <i class="fab fa-stack-overflow"></i>
    </a>
  </li>
  
</ul>

        
        
      </div>
      <div class="col-12 col-sm-4 text-center py-2 order-sm-2">
        
        
	
		
	
      </div>
    </div>
  </div>
</footer>


    </div>
    
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>













<script src="/js/main.min.63db3e552bd0543be17ce4a79a18b744e9cb72256bec42b540e3ab0cd43722d0.js" integrity="sha256-Y9s&#43;VSvQVDvhfOSnmhi3ROnLciVr7EK1QOOrDNQ3ItA=" crossorigin="anonymous"></script>




  </body>
</html>